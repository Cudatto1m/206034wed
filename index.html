<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Web LÆ°u Máº­t Kháº©u ğŸ”</title>
  <style>
    body { font-family: Arial; max-width: 600px; margin: 0 auto; padding: 20px; }
    input, button { width: 100%; padding: 10px; margin: 8px 0; }
    #accounts { margin-top: 20px; }
    button { cursor: pointer; }
  </style>
</head>
<body>
  <h2>ğŸ—ï¸ LÆ°u tÃ i khoáº£n cá»§a tÃ´i</h2>
  <div id="status">ğŸ”’ ChÆ°a Ä‘Äƒng nháº­p</div>
  <button onclick="login()">ğŸ”‘ ÄÄƒng nháº­p Google</button>
  <button onclick="logout()">ğŸšª ÄÄƒng xuáº¥t</button>
  <br><br>

  <input id="user" placeholder="TÃªn tÃ i khoáº£n">
  <input id="pass" placeholder="Máº­t kháº©u" type="password">
  <button onclick="save()">ğŸ’¾ LÆ°u</button>
  <button onclick="load()">ğŸ“‚ Xem láº¡i</button>

  <div id="accounts"></div>

  <script type="module">
    // 1. Import cÃ¡c hÃ m cáº§n thiáº¿t tá»« cÃ¡c SDK Firebase Modular
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"; // Giá»¯ phiÃªn báº£n 10.12.2 hoáº·c cáº­p nháº­t lÃªn 12.0.0
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, doc, setDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    // Náº¿u báº¡n muá»‘n dÃ¹ng Analytics, hÃ£y thÃªm vÃ o:
    // import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";

    // 2. Cáº¥u hÃ¬nh Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCXTQVya0GaJYTff_KDK8Sn0mmTJuHbS4g",
      authDomain: "wed-luu-tt.firebaseapp.com",
      projectId: "wed-luu-tt",
      storageBucket: "wed-luu-tt.firebasestorage.app",
      messagingSenderId: "1055841731330",
      appId: "1:1055841731330:web:6f50a5d320fdfae7feb81b",
      measurementId: "G-MD2TE7537J" // Náº¿u dÃ¹ng Analytics
    };

    // 3. Khá»Ÿi táº¡o Firebase vÃ  cÃ¡c dá»‹ch vá»¥
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app); // Láº¥y Ä‘á»‘i tÆ°á»£ng Auth tá»« app
    const db = getFirestore(app); // Láº¥y Ä‘á»‘i tÆ°á»£ng Firestore tá»« app
    let currentUser = null;

    // Náº¿u báº¡n muá»‘n dÃ¹ng Analytics:
    // const analytics = getAnalytics(app);

    // 4. CÃ¡c hÃ m xá»­ lÃ½ logic cá»§a á»©ng dá»¥ng
    // Theo dÃµi tráº¡ng thÃ¡i Ä‘Äƒng nháº­p
    onAuthStateChanged(auth, (user) => { // DÃ¹ng onAuthStateChanged Ä‘Æ°á»£c import
      currentUser = user;
      document.getElementById("status").innerText = user
        ? "âœ… ÄÃ£ Ä‘Äƒng nháº­p: " + user.email
        : "ğŸ”’ ChÆ°a Ä‘Äƒng nháº­p";
    });

    // ÄÄƒng nháº­p Google
    window.login = () => { // Äáº·t hÃ m vÃ o window Ä‘á»ƒ cÃ³ thá»ƒ gá»i tá»« onclick
      const provider = new GoogleAuthProvider(); // DÃ¹ng GoogleAuthProvider Ä‘Æ°á»£c import
      signInWithPopup(auth, provider) // DÃ¹ng signInWithPopup Ä‘Æ°á»£c import
        .then(res => alert("ÄÄƒng nháº­p thÃ nh cÃ´ng âœ…"))
        .catch(err => alert("Lá»—i Ä‘Äƒng nháº­p âŒ: " + err.message));
    }

    // ÄÄƒng xuáº¥t
    window.logout = () => { // Äáº·t hÃ m vÃ o window
      signOut(auth) // DÃ¹ng signOut Ä‘Æ°á»£c import
        .then(() => alert("ÄÃ£ Ä‘Äƒng xuáº¥t âœ…"))
        .catch(err => alert("Lá»—i khi Ä‘Äƒng xuáº¥t âŒ: " + err.message));
    }

    // HÃ m mÃ£ hÃ³a SHA-256 (giá»¯ nguyÃªn)
    async function hash(text) {
      const data = new TextEncoder().encode(text);
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      return [...new Uint8Array(hashBuffer)]
        .map(b => b.toString(16).padStart(2, '0')).join('');
    }

    // LÆ°u tÃ i khoáº£n
    window.save = async () => { // Äáº·t hÃ m vÃ o window
      if (!currentUser) return alert("â—Báº¡n cáº§n Ä‘Äƒng nháº­p!");

      const user = document.getElementById("user").value.trim();
      const pass = document.getElementById("pass").value.trim();
      if (!user || !pass) return alert("â—HÃ£y nháº­p Ä‘áº§y Ä‘á»§!");

      const hashed = await hash(pass);

      // Sá»­ dá»¥ng cÃ¡c hÃ m Firestore modular
      const userDocRef = doc(collection(db, "users", currentUser.uid, "accounts"), user);
      setDoc(userDocRef, { password: hashed })
        .then(() => alert("âœ… ÄÃ£ lÆ°u"))
        .catch(err => alert("âŒ Lá»—i khi lÆ°u: " + err.message));
    }

    // Xem láº¡i tÃ i khoáº£n Ä‘Ã£ lÆ°u
    window.load = () => { // Äáº·t hÃ m vÃ o window
      if (!currentUser) return alert("â—Báº¡n cáº§n Ä‘Äƒng nháº­p!");

      // Sá»­ dá»¥ng cÃ¡c hÃ m Firestore modular
      const accountsCollectionRef = collection(db, "users", currentUser.uid, "accounts");
      getDocs(accountsCollectionRef)
        .then(snapshot => {
          if (snapshot.empty) return document.getElementById("accounts").innerHTML = "KhÃ´ng cÃ³ dá»¯ liá»‡u";
          let html = "<h3>ğŸ“‹ Danh sÃ¡ch tÃ i khoáº£n:</h3><ul>";
          snapshot.forEach(doc => {
            html += `<li><b>${doc.id}</b>: ${doc.data().password}</li>`;
          });
          html += "</ul>";
          document.getElementById("accounts").innerHTML = html;
        })
        .catch(err => alert("âŒ Lá»—i khi táº£i dá»¯ liá»‡u: " + err.message));
    }
  </script>
</body>
</html>
